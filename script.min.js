// ==UserScript==
// @name         Gaps N' Laps
// @namespace    https://github.com/Arkitektum/gaps-n-laps-js
// @version      1.0.0
// @description  Enhances the Tripletex time report table by grouping entries, calculating total time, gaps, and overlaps, and visualizing them with a timeline.
// @author       Jørgen Tellnes & Benjamin Dehli
// @match        https://tripletex.no/execute/updateHourlist?*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=tripletex.no
// @grant        none
// ==/UserScript==
!function(){"use strict";function e(e,t,l,r){var n,i;let a=document.createElement("span"),s=r?e>l:e<l;a.style.display="inline-flex",a.style.alignItems="center",a.style.marginRight="14px",a.style.fontSize="14px",a.style.color=s?"#e63946":"#2a9d60",a.style.whiteSpace="break-spaces";let o=Math.floor((n=e)/36e5),$=Math.floor((i=e)%36e5/6e4);return a.innerHTML=`${s?"⚠️ ":"✅ "}${t}: <span style="font-weight: 500;">${o}t ${$}m</span>`,a}let t=new MutationObserver(e=>{for(let t of e){let r=document.getElementById("timeReportTable");if(r&&!r.dataset._seen&&(r.dataset._seen="true",l(r)),!r){let n=document.querySelector('[data-_seen="true"]');n&&n.removeAttribute("data-_seen")}}});function l(t){let l=t.querySelector("tbody"),r=function e(t){let l=[],r=null,n=t.querySelectorAll("tr");return n.forEach(e=>{if(e.id)r={headerRowElementId:e.id,intervals:[]},l.push(r);else if(r){let t=e.querySelector(".timeReportStopwatchIntervals strong");t&&r.intervals.push(...function e(t){let l=t.trim(),r=/\((\d{2}):(\d{2})\s*-\s*(\d{2}):(\d{2})\)/g,n,i=[],a=new Date,s=a.getFullYear(),o=a.getMonth(),$=a.getDate();for(;null!==(n=r.exec(l));){let[,p,d,m,u]=n,c=new Date(s,o,$,p,d),h=new Date(s,o,$,m,u);h<c&&h.setDate(h.getDate()+1),i.push({startTime:c,stopTime:h})}return i}(t.textContent.trim()))}}),l.forEach(e=>{var t,l,r;e.intervals.sort((e,t)=>e.startTime-t.startTime),e.totalTime=(t=e).intervals.reduce((e,t)=>e+(t.stopTime-t.startTime),0),e.startTime=(l=e).intervals.length>0?l.intervals[0].startTime:null,e.stopTime=(r=e).intervals.length>0?r.intervals[r.intervals.length-1].stopTime:null,e.totalGapTimeMs=function e(t){let l=0;for(let r=1;r<t.intervals.length;r++){let n=t.intervals[r].startTime-t.intervals[r-1].stopTime;n>0&&(l+=n)}return l}(e),e.totalOverlapTimeMs=function e(t){let l=0;for(let r=1;r<t.intervals.length;r++){let n=t.intervals[r-1].stopTime-t.intervals[r].startTime;n>0&&(l+=n)}return l}(e)}),l}(l);!function t(l){var r;let n=Math.max(...(r=l).map(e=>e.totalTime));l.forEach(t=>{let l=document.getElementById(t.headerRowElementId);if(l){var r,i,a;!function e(t){if(t){let l=t.querySelectorAll("td");l.forEach(e=>{e.colSpan=1})}}(l);let s=document.createElement("td");s.colSpan=3,s.style.textAlign="right";let o=e(r=t.totalTime,"Tid",27e6,!1),$=e(i=t.totalGapTimeMs,"Pause",18e5,!0),p=e(a=t.totalOverlapTimeMs,"Overlapp",0,!0);s.appendChild(p),s.appendChild($),s.appendChild(o),l.appendChild(s);let d=document.createElement("tr"),m=document.createElement("td");m.colSpan=4,m.style.padding="4px 24px";let u=function e(t,l){let r="http://www.w3.org/2000/svg",n=document.createElementNS(r,"svg");return n.setAttribute("width","100%"),n.setAttribute("height","30"),t.intervals.forEach(e=>{let i=document.createElementNS(r,"rect"),a=(e.startTime-t.startTime)/l*100,s=(e.stopTime-e.startTime)/l*100;i.setAttribute("x",`${a}%`),i.setAttribute("y","0"),i.setAttribute("width",`${s}%`),i.setAttribute("height","30"),i.setAttribute("fill","rgba(0, 90, 214, 0.5)"),n.appendChild(i)}),n}(t,n);m.appendChild(u),d.appendChild(m),l.insertAdjacentElement("afterend",d)}})}(r)}t.observe(document.body,{childList:!0,subtree:!0})}();